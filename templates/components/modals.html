<!-- Modals Component - FIXED Media Picker Sizing -->

<!-- Toast Notification -->
<div v-if="toast.show" class="toast">
    <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;" :style="{background: getToastColor(toast.type)}">
            <i :class="getToastIcon(toast.type)" style="color: white; font-size: 18px;"></i>
        </div>
        <div style="flex: 1;">
            <p style="font-weight: 600; color: #1a202c;">[[ toast.message ]]</p>
        </div>
        <button @click="toast.show = false" style="color: #718096; background: none; border: none; cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- Confirm Dialog Modal -->
<div v-if="dialog.show" class="fixed inset-0 modal-overlay flex items-center justify-center z-50" @click="dialog.show = false">
    <div class="modal-content" style="padding: 32px;" @click.stop>
        <div style="text-align: center;">
            <div style="width: 64px; height: 64px; margin: 0 auto 20px; border-radius: 16px; display: flex; align-items: center; justify-content: center;" :style="{background: getToastColor(dialog.type)}">
                <i :class="getDialogIcon(dialog.type)" style="font-size: 32px; color: white;"></i>
            </div>
            <h3 style="font-size: 24px; font-weight: 700; color: #1a202c; margin-bottom: 12px;">[[ dialog.title ]]</h3>
            <p style="color: #718096; margin-bottom: 24px; font-size: 16px;">[[ dialog.message ]]</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button v-if="dialog.type === 'confirm'" @click="handleDialogCancel" class="btn btn-secondary">
                    Cancel
                </button>
                <button @click="handleDialogConfirm" :class="'btn btn-' + (dialog.type === 'error' ? 'danger' : 'primary')">
                    [[ dialog.confirmText || 'OK' ]]
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Media Picker Modal - FIXED SIZING -->
<div v-if="showMediaPicker" class="fixed inset-0 modal-overlay flex items-center justify-center z-50" style="padding: 16px;" @click="closeMediaPicker">
    <div class="modal-content" style="padding: 20px; max-width: 900px; width: 95%;" @click.stop>
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1a202c;">
                <i class="fab fa-google-drive" style="color: #4285f4; margin-right: 8px;"></i>
                Select from Google Drive
            </h3>
            <button @click="closeMediaPicker" style="background: none; border: none; color: #718096; cursor: pointer; font-size: 20px; padding: 4px;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Multi-select Toggle -->
        <div style="margin-bottom: 12px; padding: 8px 12px; background: #f7fafc; border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                <input type="checkbox" 
                       v-model="imagePickerMode" 
                       true-value="multi" 
                       false-value="single"
                       @change="selectedImages = []"
                       class="custom-checkbox">
                <span style="font-weight: 500; font-size: 13px;">Multi-select mode</span>
            </label>
            <span v-if="imagePickerMode === 'multi'" class="badge badge-info" style="font-size: 11px; padding: 4px 8px;">
                [[ selectedImages.length ]] selected
            </span>
        </div>

        <!-- Search -->
        <div style="margin-bottom: 12px;">
            <div style="display: flex; gap: 6px;">
                <input v-model="mediaSearch" 
                       @keyup.enter="searchDriveFiles" 
                       type="text" 
                       placeholder="Search files..." 
                       style="flex: 1; padding: 8px 12px; font-size: 13px;">
                <button @click="searchDriveFiles" class="btn btn-primary" style="padding: 8px 12px; font-size: 13px;">
                    <i class="fas fa-search"></i>
                </button>
                <button v-if="mediaSearch" @click="clearMediaSearch" class="btn btn-secondary" style="padding: 8px 12px; font-size: 13px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div v-if="loadingMedia" style="text-align: center; padding: 40px;">
            <div class="spinner" style="margin: 0 auto 16px;"></div>
            <p style="font-weight: 600; color: #4a5568; font-size: 14px;">Loading files...</p>
        </div>

        <!-- Files Grid - COMPACT VERSION -->
        <div v-else-if="driveFiles.length > 0" style="max-height: 350px; overflow-y: auto; margin-bottom: 16px; padding: 4px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">
                <div v-for="file in driveFiles" :key="file.id" 
                     @click="selectMediaForPicker(file)"
                     style="background: white; border: 2px solid #e2e8f0; border-radius: 6px; padding: 6px; cursor: pointer; transition: all 0.15s;"
                     :style="pickerSelected && pickerSelected.id === file.id ? 'border-color: #667eea; background: #eef2ff; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);' : ''"
                     @mouseover="$event.currentTarget.style.borderColor = '#667eea'"
                     @mouseout="$event.currentTarget.style.borderColor = (pickerSelected && pickerSelected.id === file.id) ? '#667eea' : '#e2e8f0'">
                    <!-- Thumbnail -->
                    <div style="aspect-ratio: 1; background: #f1f3f5; border-radius: 4px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <img v-if="file.thumbnailLink" 
                             :src="file.thumbnailLink" 
                             :alt="file.name" 
                             style="width: 100%; height: 100%; object-fit: cover;">
                        <i v-else :class="getFileIcon(file.mimeType)" style="font-size: 24px; color: #cbd5e0;"></i>
                    </div>
                    <!-- File Name -->
                    <div style="font-size: 10px; font-weight: 500; color: #1a202c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;" 
                         :title="file.name">
                        [[ file.name ]]
                    </div>
                    <!-- File Size -->
                    <div style="font-size: 9px; color: #a0aec0; text-align: center;">
                        [[ file.sizeFormatted ]]
                    </div>
                    <!-- Selected Indicator -->
                    <div v-if="pickerSelected && pickerSelected.id === file.id" 
                         style="position: absolute; top: 4px; right: 4px; width: 18px; height: 18px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check" style="color: white; font-size: 9px;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div v-else style="text-align: center; padding: 40px;">
            <i class="fas fa-inbox" style="font-size: 36px; opacity: 0.3; margin-bottom: 8px; color: #718096;"></i>
            <p style="color: #718096; font-size: 14px;">No files found</p>
        </div>

        <!-- Selected File Preview -->
        <div v-if="pickerSelected" style="margin-bottom: 12px; padding: 10px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-check-circle" style="color: #22c55e; font-size: 16px;"></i>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 12px; font-weight: 600; color: #166534; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        Selected: [[ pickerSelected.name ]]
                    </div>
                    <div style="font-size: 11px; color: #15803d;">
                        [[ pickerSelected.sizeFormatted ]]
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 2px solid #e2e8f0;">
            <button @click="openFileUpload('picker')" class="btn btn-success" style="padding: 8px 14px; font-size: 13px;">
                <i class="fas fa-upload"></i> Upload New
            </button>
            <div style="display: flex; gap: 8px;">
                <button @click="closeMediaPicker" class="btn btn-secondary" style="padding: 8px 14px; font-size: 13px;">
                    Cancel
                </button>
                <button @click="confirmMediaSelection" :disabled="!pickerSelected" class="btn btn-primary" style="padding: 8px 14px; font-size: 13px;">
                    <i class="fas fa-check"></i> Select
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal - COMPACT VERSION -->
<div v-if="showUploadModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50" style="padding: 16px;" @click="closeUploadModal">
    <div class="modal-content" style="padding: 20px; max-width: 500px; width: 95%;" @click.stop>
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1a202c;">
                <i class="fas fa-cloud-upload-alt" style="color: #667eea; margin-right: 8px;"></i>
                Upload to Google Drive
            </h3>
            <button @click="closeUploadModal" style="background: none; border: none; color: #718096; cursor: pointer; font-size: 20px;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Folder indicator -->
        <div v-if="currentFolder" style="margin-bottom: 12px; padding: 8px 12px; background: #eef2ff; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-folder" style="color: #667eea;"></i>
            <span style="font-size: 13px; color: #4338ca;">Uploading to: <strong>[[ currentFolder ]]</strong></span>
        </div>

        <!-- Upload Area -->
        <div style="margin-bottom: 16px;">
            <div @click="$refs.fileInput.click()" 
                 @dragover.prevent="dragOver = true"
                 @dragleave.prevent="dragOver = false"
                 @drop.prevent="handleFileDrop"
                 class="upload-zone"
                 :class="{'drag-over': dragOver}"
                 style="padding: 24px;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 36px; color: #cbd5e0; margin-bottom: 12px;"></i>
                <p style="font-weight: 600; color: #4a5568; margin-bottom: 4px; font-size: 14px;">Click or drag files here</p>
                <p style="font-size: 12px; color: #718096;">Images, Videos, ZIP â€¢ Max 100MB</p>
            </div>
            <input type="file" ref="fileInput" @change="handleFileSelect" multiple class="hidden" accept="image/*,video/*,.zip" style="display: none;">
        </div>

        <!-- Upload Progress -->
        <div v-if="uploading" style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                <span style="font-size: 13px; color: #4a5568; font-weight: 600;">Uploading...</span>
                <span style="font-size: 13px; color: #667eea; font-weight: 600;">[[ uploadProgress ]]%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" :style="{width: uploadProgress + '%'}"></div>
            </div>
        </div>

        <!-- Selected Files -->
        <div v-if="selectedFiles.length > 0 && !uploading" style="margin-bottom: 16px;">
            <p style="font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 8px;">
                Selected ([[ selectedFiles.length ]]):
            </p>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; padding: 6px;">
                <div v-for="(file, index) in selectedFiles" :key="index" 
                     style="display: flex; align-items: center; justify-content: space-between; background: #f7fafc; padding: 8px 10px; border-radius: 4px; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                        <i class="fas fa-file" style="color: #cbd5e0; font-size: 14px;"></i>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; color: #1a202c; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">[[ file.name ]]</div>
                            <div style="font-size: 10px; color: #718096;">[[ formatBytes(file.size) ]]</div>
                        </div>
                    </div>
                    <button @click="removeFile(index)" style="background: none; border: none; color: #f56565; cursor: pointer; padding: 2px 6px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
            <button @click="closeUploadModal" :disabled="uploading" class="btn btn-secondary" style="padding: 8px 14px; font-size: 13px;">
                Cancel
            </button>
            <button @click="uploadFiles" :disabled="selectedFiles.length === 0 || uploading" class="btn btn-success" style="padding: 8px 14px; font-size: 13px;">
                <i class="fas fa-upload"></i> Upload ([[ selectedFiles.length ]])
            </button>
        </div>
    </div>
</div>

<!-- Edit Listing Modal -->
<div v-if="editingListing !== null" class="fixed inset-0 modal-overlay flex items-center justify-center z-50" style="padding: 16px;" @click="cancelEdit">
    <div class="modal-content" style="padding: 20px; max-width: 850px; width: 95%; max-height: 90vh; overflow-y: auto;" @click.stop>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1a202c;">
                <i class="fas fa-edit" style="color: #667eea; margin-right: 8px;"></i>
                Edit Vehicle Listing
            </h3>
            <button @click="cancelEdit" style="background: none; border: none; color: #718096; cursor: pointer; font-size: 20px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form @submit.prevent="updateListing">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 14px;">
                <div>
                    <label style="font-size: 13px;">Year</label>
                    <input v-model.number="editForm.Year" type="number" required style="padding: 8px 10px; font-size: 13px;">
                </div>
                <div>
                    <label style="font-size: 13px;">Make</label>
                    <select v-model="editForm.Make" required style="padding: 8px 10px; font-size: 13px;">
                        <option value="">Select Make</option>
                        <option v-for="make in makeOptions" :key="make" :value="make">[[ make ]]</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 13px;">Model</label>
                    <input v-model="editForm.Model" type="text" required style="padding: 8px 10px; font-size: 13px;">
                </div>
                <div>
                    <label style="font-size: 13px;">Mileage</label>
                    <input v-model.number="editForm.Mileage" type="number" required style="padding: 8px 10px; font-size: 13px;">
                </div>
                <div>
                    <label style="font-size: 13px;">Price</label>
                    <input v-model.number="editForm.Price" type="number" required style="padding: 8px 10px; font-size: 13px;">
                </div>
                <div>
                    <label style="font-size: 13px;">Body Style</label>
                    <select v-model="editForm['Body Style']" required style="padding: 8px 10px; font-size: 13px;">
                        <option value="">Select Style</option>
                        <option v-for="style in bodyStyles" :key="style" :value="style">[[ style ]]</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 13px;">Exterior Color</label>
                    <select v-model="editForm['Exterior Color']" required style="padding: 8px 10px; font-size: 13px;">
                        <option value="">Select Color</option>
                        <option v-for="color in colorOptions" :key="color" :value="color">[[ color ]]</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 13px;">Interior Color</label>
                    <select v-model="editForm['Interior Color']" required style="padding: 8px 10px; font-size: 13px;">
                        <option value="">Select Color</option>
                        <option v-for="color in colorOptions" :key="color" :value="color">[[ color ]]</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 13px;">Condition</label>
                    <select v-model="editForm['Vehicle Condition']" required style="padding: 8px 10px; font-size: 13px;">
                        <option value="">Select Condition</option>
                        <option v-for="condition in conditions" :key="condition" :value="condition">[[ condition ]]</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 13px;">Fuel Type</label>
                    <select v-model="editForm['Fuel Type']" required style="padding: 8px 10px; font-size: 13px;">
                        <option value="">Select Fuel</option>
                        <option v-for="fuel in fuelTypes" :key="fuel" :value="fuel">[[ fuel ]]</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 13px;">Transmission</label>
                    <select v-model="editForm.Transmission" required style="padding: 8px 10px; font-size: 13px;">
                        <option value="">Select Transmission</option>
                        <option value="Manual transmission">Manual</option>
                        <option value="Automatic transmission">Automatic</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 13px;">Images Path</label>
                    <div style="display: flex; gap: 6px;">
                        <input v-model="editForm['Images Path']" type="text" required style="flex: 1; padding: 8px 10px; font-size: 13px;">
                        <button type="button" @click="openMediaPicker('edit')" class="btn btn-primary" style="padding: 8px 10px;">
                            <i class="fas fa-folder-open"></i>
                        </button>
                        <button type="button" @click="openFileUpload('edit')" class="btn btn-success" style="padding: 8px 10px;">
                            <i class="fas fa-upload"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 14px;">
                <label style="font-size: 13px;">Description</label>
                <textarea v-model="editForm.Description" rows="3" required style="padding: 8px 10px; font-size: 13px;"></textarea>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="font-size: 13px;">Selected Day</label>
                <select v-model="editForm.selectedDay" style="padding: 8px 10px; font-size: 13px;">
                    <option value="">Select Day</option>
                    <option v-for="day in days" :key="day" :value="day">[[ day ]]</option>
                </select>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 12px; border-top: 2px solid #e2e8f0;">
                <button type="button" @click="cancelEdit" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>