        openMediaPicker(mode) { this.pickerMode = mode; this.showMediaPicker = true; this.pickerSelected = null; if (this.driveFiles.length === 0) { this.loadDriveFiles(); } },
        closeMediaPicker() { this.showMediaPicker = false; this.pickerSelected = null; this.mediaSearch = ''; },
        selectMediaForPicker(file) { this.pickerSelected = file; },
        confirmMediaSelection() { if (!this.pickerSelected) return; const filePath = this.pickerSelected.webViewLink || 'https://drive.google.com/uc?id=' + this.pickerSelected.id; if (this.pickerMode === 'new') { this.newListing['Images Path'] = filePath; } else if (this.pickerMode === 'edit') { this.editForm['Images Path'] = filePath; } this.closeMediaPicker(); this.showToast('success', 'Media file selected!'); },
        searchDriveFiles() { if (!this.mediaSearch.trim()) { this.loadDriveFiles(); return; } this.loadingMedia = true; axios.get('/search_drive_files', { params: { q: this.mediaSearch } }).then(response => { if (response.data.status === 'success') { this.driveFiles = response.data.files; } }).catch(error => { this.showToast('error', 'Search failed'); }).finally(() => { this.loadingMedia = false; }); },
        clearMediaSearch() { this.mediaSearch = ''; this.loadDriveFiles(); },
        openFileUpload(mode) { this.currentFolder = ''; this.pickerMode = mode; this.showUploadModal = true; this.selectedFiles = []; this.uploadProgress = 0; },
        closeUploadModal() { if (!this.uploading) { this.showUploadModal = false; this.selectedFiles = []; this.uploadProgress = 0; this.currentFolder = ''; } },
        handleFileSelect(event) { const files = Array.from(event.target.files); this.selectedFiles = [...this.selectedFiles, ...files]; },
        handleFileDrop(event) { this.dragOver = false; const files = Array.from(event.dataTransfer.files); this.selectedFiles = [...this.selectedFiles, ...files]; },
        removeFile(index) { this.selectedFiles.splice(index, 1); },
        uploadFiles() { if (this.selectedFiles.length === 0) { this.showToast('warning', 'No files selected'); return; } this.uploading = true; this.uploadProgress = 0; const totalFiles = this.selectedFiles.length; let uploadedCount = 0; let lastUploadedFile = null; const uploadNext = (index) => { if (index >= this.selectedFiles.length) { this.uploading = false; this.uploadProgress = 100; this.showDialog('success', 'Upload Complete', 'Uploaded ' + uploadedCount + ' of ' + totalFiles + ' file(s)!'); if (lastUploadedFile && (this.pickerMode === 'new' || this.pickerMode === 'edit' || this.pickerMode === 'picker')) { const filePath = lastUploadedFile.webViewLink || 'https://drive.google.com/uc?id=' + lastUploadedFile.id; if (this.pickerMode === 'new') { this.newListing['Images Path'] = filePath; } else if (this.pickerMode === 'edit') { this.editForm['Images Path'] = filePath; } else if (this.pickerMode === 'picker') { this.pickerSelected = lastUploadedFile; this.confirmMediaSelection(); } } this.closeUploadModal(); if (this.activeTab === 'media') { this.loadDriveStructure(); } else { this.loadDriveFiles(); } return; } const file = this.selectedFiles[index]; const formData = new FormData(); formData.append('file', file); if (this.currentFolder) { formData.append('folder_name', this.currentFolder); } axios.post('/upload_to_drive', formData, { headers: {'Content-Type': 'multipart/form-data'}, timeout: 120000 }).then(response => { if (response.data.status === 'success') { uploadedCount++; lastUploadedFile = response.data.file; this.uploadProgress = Math.round(((index + 1) / totalFiles) * 100); this.showToast('success', 'Uploaded: ' + file.name); uploadNext(index + 1); } else { this.showToast('error', 'Failed: ' + file.name); uploadNext(index + 1); } }).catch(error => { this.showToast('error', 'Failed: ' + file.name); uploadNext(index + 1); }); }; uploadNext(0); },
        loadScheduledPosts() { this.loadingSchedule = true; axios.get('/get_scheduled_posts').then(response => { if (response.data.status === 'success') { this.scheduledPosts = response.data.scheduled_posts; } else { this.showToast('error', 'Failed to load scheduled posts'); } this.loadScheduleStats(); }).catch(error => { this.showToast('error', 'Failed to load scheduled posts'); }).finally(() => { this.loadingSchedule = false; }); },
        loadScheduleStats() { axios.get('/get_schedule_stats').then(response => { if (response.data.status === 'success') { this.scheduleStats = response.data.stats; } }).catch(error => { console.error('Error loading schedule stats:', error); }); },
        scheduleNewPost() { if (!this.scheduleForm.listing_ids || this.scheduleForm.listing_ids.length === 0) { this.showToast('warning', 'Please select at least one listing'); return; } if (!this.scheduleForm.profile_ids || this.scheduleForm.profile_ids.length === 0) { this.showToast('warning', 'Please select at least one Edge profile'); return; } if (!this.scheduleForm.datetime) { this.showToast('warning', 'Please select a date and time'); return; } const totalCombinations = this.scheduleForm.listing_ids.length * this.scheduleForm.profile_ids.length; if (totalCombinations > 50) { this.showToast('error', `Too many combinations (${totalCombinations}). Maximum is 50.`); return; } const localDateTime = this.scheduleForm.datetime; const isoString = localDateTime.replace('T', ' ') + ':00'; const scheduleData = { listing_ids: this.scheduleForm.listing_ids, profile_ids: this.scheduleForm.profile_ids, scheduled_datetime: isoString, recurrence: this.scheduleForm.recurrence || 'none' }; axios.post('/schedule_posts_bulk', scheduleData).then(response => { if (response.data.status === 'success') { this.showDialog('success', 'Success!', `Created ${response.data.count} scheduled post(s)!`); this.loadScheduledPosts(); this.scheduleForm = { listing_ids: [], profile_ids: [], datetime: '', recurrence: 'none' }; } else { this.showDialog('error', 'Error', response.data.message || 'Failed to schedule posts'); } }).catch(error => { this.showDialog('error', 'Error', error.response?.data?.message || 'Failed to schedule posts'); }); },
        saveScheduledPost() { if (this.editingSchedule) { this.updateScheduledPost(); } else { this.scheduleNewPost(); } },
        editScheduledPost(post) { const datetime = post.next_run_datetime.replace(' ', 'T').split('.')[0]; if (datetime.length === 16) { this.scheduleForm.datetime = datetime; } else if (datetime.length === 19) { this.scheduleForm.datetime = datetime.substring(0, 16); } else { this.scheduleForm.datetime = datetime; } this.scheduleForm.listing_id = post.listing_id; this.scheduleForm.profile_id = post.profile_id; this.scheduleForm.profile_name = post.profile_name; this.scheduleForm.profile_path = post.profile_folder || post.profile_path; this.scheduleForm.location = post.location; this.scheduleForm.recurrence = post.recurrence || 'none'; this.selectedScheduleProfile = this.profiles.find(p => p.id === post.profile_id); this.editingSchedule = post; window.scrollTo({ top: 0, behavior: 'smooth' }); },
        updateScheduledPost() { if (!this.scheduleForm.listing_id) { this.showToast('warning', 'Please select a listing'); return; } if (!this.scheduleForm.profile_id) { this.showToast('warning', 'Please select an Edge profile'); return; } if (!this.scheduleForm.datetime) { this.showToast('warning', 'Please select a date and time'); return; } const localDateTime = this.scheduleForm.datetime; const isoString = localDateTime.replace('T', ' ') + ':00'; const updateData = { schedule_id: this.editingSchedule.id, listing_id: this.scheduleForm.listing_id, profile_id: this.scheduleForm.profile_id, profile_name: this.scheduleForm.profile_name, profile_path: this.scheduleForm.profile_path, scheduled_datetime: isoString, recurrence: this.scheduleForm.recurrence || 'none' }; axios.post('/update_scheduled_post_full', updateData).then(response => { if (response.data.status === 'success') { this.showDialog('success', 'Success!', 'Scheduled post updated'); this.loadScheduledPosts(); this.cancelEditSchedule(); } else { this.showDialog('error', 'Error', response.data.message || 'Failed to update'); } }).catch(error => { this.showDialog('error', 'Error', error.response?.data?.message || 'Failed to update'); }); },
        cancelEditSchedule() { this.editingSchedule = null; this.scheduleForm = { listing_ids: [], profile_ids: [], datetime: '', recurrence: 'none' }; },
        async cancelScheduledPost(scheduleId) { const confirmed = await this.showDialog('confirm', 'Cancel Schedule', 'Are you sure you want to cancel this scheduled post?', 'Cancel Post'); if (!confirmed) return; axios.post('/update_scheduled_post', { schedule_id: scheduleId, status: 'cancelled' }).then(response => { if (response.data.status === 'success') { this.showToast('success', 'Scheduled post cancelled'); this.loadScheduledPosts(); } else { this.showToast('error', response.data.message || 'Failed to cancel'); } }).catch(error => { this.showToast('error', 'Failed to cancel scheduled post'); }); },
        async deleteScheduledPost(scheduleId) { const confirmed = await this.showDialog('confirm', 'Delete Schedule', 'Are you sure you want to delete this scheduled post?', 'Delete'); if (!confirmed) return; axios.post('/delete_scheduled_post', { schedule_id: scheduleId }).then(response => { if (response.data.status === 'success') { this.showToast('success', 'Scheduled post deleted'); this.loadScheduledPosts(); } else { this.showToast('error', response.data.message || 'Failed to delete'); } }).catch(error => { this.showToast('error', 'Failed to delete scheduled post'); }); },
        loadSchedulerStatus() { axios.get('/scheduler_status').then(response => { if (response.data.status === 'success') { this.schedulerStatus = response.data; } }).catch(error => { console.error('Error loading scheduler status:', error); }); },
        startScheduler() { axios.post('/start_scheduler').then(response => { if (response.data.status === 'success') { this.showToast('success', 'Scheduler service started'); this.loadSchedulerStatus(); } else { this.showToast('warning', response.data.message || 'Scheduler already running'); } }).catch(error => { this.showToast('error', error.response?.data?.message || 'Failed to start scheduler'); }); },
        stopScheduler() { axios.post('/stop_scheduler').then(response => { if (response.data.status === 'success') { this.showToast('success', 'Scheduler service stopped'); this.loadSchedulerStatus(); } else { this.showToast('warning', response.data.message || 'Scheduler not running'); } }).catch(error => { this.showToast('error', error.response?.data?.message || 'Failed to stop scheduler'); }); },
