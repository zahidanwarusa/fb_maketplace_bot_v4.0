<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Marketplace Automation</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto p-4">
        <nav class="bg-white shadow-lg rounded-lg p-4 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Facebook Marketplace Automation</h1>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Profile Management Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-user-circle mr-2"></i>Chrome Profiles
                </h2>
                <div class="space-y-4">
                    <div v-for="profile in profiles" :key="profile.folder_name" class="flex items-center space-x-4">
                        <input 
                            type="checkbox" 
                            v-model="selectedProfiles" 
                            :value="profile"
                            class="form-checkbox h-5 w-5 text-blue-600">
                        <span class="text-gray-700 font-medium">
                            [[ profile.user_name ]] ([[ profile.folder_name ]])
                        </span>
                        <input 
                            type="text" 
                            v-model="profileLocations[profile.folder_name]" 
                            placeholder="Enter location"
                            @change="updateProfileLocation(profile.folder_name)"
                            class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Add Listing Form -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-plus-circle mr-2"></i>Add New Listing
                </h2>
                <form @submit.prevent="addListing" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                            <input v-model.number="newListing.Year" type="number" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Make</label>
                            <select v-model="newListing.Make" class="w-full p-2 border rounded bg-white" required>
                                <option value="">Select Make</option>
                                <option v-for="make in makeOptions" :key="make" :value="make">[[ make ]]</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                            <input v-model="newListing.Model" type="text" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mileage</label>
                            <input v-model.number="newListing.Mileage" type="number" class="w-full p-2 border rounded" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                            <input v-model.number="newListing.Price" type="number" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Body Style</label>
                            <select v-model="newListing['Body Style']" class="w-full p-2 border rounded bg-white" required>
                                <option value="">Select Body Style</option>
                                <option v-for="style in bodyStyles" :key="style" :value="style">[[ style ]]</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Exterior Color</label>
                            <select v-model="newListing['Exterior Color']" class="w-full p-2 border rounded bg-white" required>
                                <option value="">Select Color</option>
                                <option v-for="color in colorOptions" :key="color" :value="color">[[ color ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Interior Color</label>
                            <select v-model="newListing['Interior Color']" class="w-full p-2 border rounded bg-white" required>
                                <option value="">Select Color</option>
                                <option v-for="color in colorOptions" :key="color" :value="color">[[ color ]]</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Vehicle Condition</label>
                            <select v-model="newListing['Vehicle Condition']" class="w-full p-2 border rounded bg-white" required>
                                <option value="">Select Condition</option>
                                <option v-for="condition in conditions" :key="condition" :value="condition">[[ condition ]]</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fuel Type</label>
                            <select v-model="newListing['Fuel Type']" class="w-full p-2 border rounded bg-white" required>
                                <option value="">Select Fuel Type</option>
                                <option v-for="fuel in fuelTypes" :key="fuel" :value="fuel">[[ fuel ]]</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transmission</label>
                            <select v-model="newListing.Transmission" class="w-full p-2 border rounded bg-white" required>
                                <option value="">Select Transmission</option>
                                <option value="Manual transmission">Manual transmission</option>
                                <option value="Automatic transmission">Automatic transmission</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Images Path</label>
                            <input v-model="newListing['Images Path']" type="text" class="w-full p-2 border rounded" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea v-model="newListing.Description" class="w-full p-2 border rounded" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors">
                        Add Listing
                    </button>
                </form>
            </div>
        </div>

        <!-- Existing Listings Section -->
        <div class="mt-6 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-list mr-2"></i>Existing Listings
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Images Path</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="(listing, index) in listings" :key="index">
                            <td class="px-6 py-4">
                                <input type="checkbox" v-model="selectedListings" :value="index" class="form-checkbox h-5 w-5 text-blue-600">
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">
                                    [[ listing.Year ]] [[ listing.Make ]] [[ listing.Model ]]
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-500">
                                    [[ listing['Body Style'] ]] • [[ listing['Exterior Color'] ]] • [[ listing.Mileage ]] miles
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">
                                    $[[ listing.Price?.toLocaleString() ]]
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-500">
                                    [[ listing['Images Path'] ]]
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <select v-model="listing.selectedDay" class="text-sm p-1 border rounded">
                                    <option value="">Select Day</option>
                                    <option v-for="day in days" :key="day" :value="day">[[ day ]]</option>
                                </select>
                            </td>
                            <td class="px-6 py-4">
                                <button @click="deleteListing(index)" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex justify-end space-x-4">
            <button 
                @click="runBot" 
                :disabled="isRunning || !hasSelections" 
                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center">
                <i class="fas fa-play mr-2"></i>
                [[ isRunning ? 'Running...' : 'Run Bot' ]]
            </button>
        </div>

        <!-- Logs Section -->
        <div v-if="logs" class="mt-6 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-terminal mr-2"></i>Execution Logs
            </h2>
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg">
                <pre class="whitespace-pre-wrap font-mono text-sm">[[ logs ]]</pre>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data: {
                profiles: {{ profiles | tojson | safe }},
                listings: {{ listings | tojson | safe }},
                profileLocations: {{ profile_locations | tojson | safe }},
                selectedProfiles: [],
                selectedListings: [],
                logs: '',
                isRunning: false,
                newListing: {
                    Year: '',
                    Make: '',
                    Model: '',
                    Mileage: '',
                    Price: '',
                    'Body Style': '',
                    'Exterior Color': '',
                    'Interior Color': '',
                    'Vehicle Condition': '',
                    'Fuel Type': '',
                    Transmission: '',
                    Description: '',
                    'Images Path': '',
                    'selectedDay': ''
                },
                days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                colorOptions: [
                    'Black', 'Blue', 'Brown', 'Gold', 'Green', 'Gray', 'Pink', 'Purple',
                    'Red', 'Silver', 'Orange', 'White', 'Yellow', 'Charcoal', 'Off white',
                    'Tan', 'Beige', 'Burgundy', 'Turquoise'
                ],
                makeOptions: [
                    'Acura', 'Alfa Romeo', 'Aston Martin', 'Audi', 'BMW', 'Bentley', 'Buick',
                    'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ferrari', 'Fiat', 'Ford',
                    'GMC', 'Genesis', 'Honda', 'Hyundai', 'Infiniti', 'Jaguar', 'Jeep',
                    'Kia', 'Lamborghini', 'Land Rover', 'Lexus', 'Lincoln', 'Maserati',
                    'Mazda', 'Mercedes-Benz', 'Mini', 'Mitsubishi', 'Nissan', 'Porsche',
                    'Ram', 'Subaru', 'Tesla', 'Toyota', 'Volkswagen', 'Volvo'
                ],
                bodyStyles: [
                    'Sedan', 'SUV', 'Coupe', 'Truck', 'Hatchback', 'Convertible',
                    'Wagon', 'Minivan', 'Small Car', 'Other'
                ],
                conditions: [
                    'Excellent', 'Very good', 'Good', 'Fair', 'Poor'
                ],
                fuelTypes: [
                    'Diesel', 'Electric', 'Gasoline', 'Flex', 'Hybrid', 
                    'Petrol', 'Plug-in hybrid', 'Other'
                ]
            },
            computed: {
                hasSelections() {
                    return this.selectedProfiles.length > 0 && this.selectedListings.length > 0;
                }
            },
            methods: {
                updateProfileLocation(folderName) {
                    axios.post('/update_profile_location', {
                        profile: folderName,
                        location: this.profileLocations[folderName]
                    })
                    .then(response => {
                        if (response.data.status === 'success') {
                            alert('Location updated successfully');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating profile location:', error);
                        alert('Error updating location. Please try again.');
                    });
                },
                addListing() {
                    // Create a copy of the listing data
                    const listingData = {...this.newListing};
                    
                    // Validate required fields
                    const requiredFields = [
                        'Year', 'Make', 'Model', 'Mileage', 'Price', 
                        'Body Style', 'Exterior Color', 'Interior Color', 
                        'Vehicle Condition', 'Fuel Type', 'Transmission', 
                        'Description', 'Images Path'
                    ];
                    
                    for (const field of requiredFields) {
                        if (!listingData[field]) {
                            alert(`Please fill in the ${field} field`);
                            return;
                        }
                    }

                    // Validate numerical fields
                    if (isNaN(listingData.Year) || listingData.Year <= 0) {
                        alert('Please enter a valid year');
                        return;
                    }
                    if (isNaN(listingData.Mileage) || listingData.Mileage < 0) {
                        alert('Please enter a valid mileage');
                        return;
                    }
                    if (isNaN(listingData.Price) || listingData.Price <= 0) {
                        alert('Please enter a valid price');
                        return;
                    }

                    axios.post('/add_listing', listingData)
                        .then(response => {
                            if (response.data.status === 'success') {
                                // Add to local listings array
                                this.listings.push({...listingData});
                                
                                // Reset form
                                this.newListing = {
                                    Year: '',
                                    Make: '',
                                    Model: '',
                                    Mileage: '',
                                    Price: '',
                                    'Body Style': '',
                                    'Exterior Color': '',
                                    'Interior Color': '',
                                    'Vehicle Condition': '',
                                    'Fuel Type': '',
                                    Transmission: '',
                                    Description: '',
                                    'Images Path': '',
                                    'selectedDay': ''
                                };
                                
                                alert('Listing added successfully!');
                            }
                        })
                        .catch(error => {
                            console.error('Error adding listing:', error);
                            alert('Error adding listing. Please try again.');
                        });
                },
                deleteListing(index) {
                    if (confirm('Are you sure you want to delete this listing?')) {
                        axios.post('/delete_listing', { index: index })
                            .then(response => {
                                if (response.data.status === 'success') {
                                    this.listings.splice(index, 1);
                                    this.selectedListings = this.selectedListings.filter(i => i !== index);
                                    alert('Listing deleted successfully');
                                }
                            })
                            .catch(error => {
                                console.error('Error deleting listing:', error);
                                alert('Error deleting listing. Please try again.');
                            });
                    }
                },
                runBot() {
                    if (!this.hasSelections) {
                        alert('Please select at least one profile and one listing.');
                        return;
                    }
                    
                    // Check if all selected profiles have locations
                    const missingLocations = this.selectedProfiles.filter(p => !this.profileLocations[p.folder_name]);
                    if (missingLocations.length > 0) {
                        alert(`Please set locations for the following profiles:\n${missingLocations.map(p => p.user_name).join('\n')}`);
                        return;
                    }

                    // Check if selected listings have days selected
                    const listingsData = this.selectedListings.map(index => ({
                        ...this.listings[index],
                        selectedDay: this.listings[index].selectedDay
                    }));

                    const missingDays = listingsData.filter(l => !l.selectedDay);
                    if (missingDays.length > 0) {
                        alert('Please select a day for all selected listings');
                        return;
                    }

                    this.isRunning = true;
                    this.logs = 'Initializing bot...\n';
                    
                    axios.post('/run_bot', {
                        profiles: this.selectedProfiles,
                        listings: this.selectedListings,
                        listingsData: listingsData
                    })
                    .then(response => {
                        this.logs += response.data.stdout;
                        if (response.data.stderr) {
                            this.logs += '\nErrors:\n' + response.data.stderr;
                        }
                    })
                    .catch(error => {
                        this.logs += 'Error: ' + error;
                        alert('Error running bot. Please check the logs.');
                    })
                    .finally(() => {
                        this.isRunning = false;
                    });
                }
            }
        });
    </script>
</body>
</html>